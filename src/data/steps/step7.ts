import { Step } from '../types';

export const step7: Step = {
  "id": "7",
  "title": "Mocking Modules - Testing with External Dependencies",
  "initialCode": "// ============================================\r\n// STEP 7: Mocking Modules\r\n// ============================================\r\n\r\n// Note: Since playground doesn't support file systems,\r\n// we'll simulate module mocking patterns\r\n\r\n// Simulated modules (normally these would be in separate files)\r\n\r\n// api.js module simulation\r\nconst api = {\r\n  get: async (url) => {\r\n    // Real implementation would call HTTP endpoint\r\n    return { data: { id: 1, name: 'Real Data' } };\r\n  },\r\n  post: async (url, data) => {\r\n    return { data: { success: true, id: 1 } };\r\n  },\r\n  put: async (url, data) => {\r\n    return { data: { success: true } };\r\n  },\r\n  delete: async (url) => {\r\n    return { data: { success: true } };\r\n  }\r\n};\r\n\r\n// utils.js module simulation\r\nconst utils = {\r\n  formatDate: (date) => date.toISOString(),\r\n  generateId: () => Math.random().toString(36).substr(2, 9),\r\n  validateEmail: (email) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email),\r\n  calculateAge: (birthDate) => {\r\n    const today = new Date();\r\n    const birth = new Date(birthDate);\r\n    return today.getFullYear() - birth.getFullYear();\r\n  }\r\n};\r\n\r\n// UserService using external dependencies\r\nclass UserService {\r\n  constructor(apiClient) {\r\n    this.apiClient = apiClient;\r\n  }\r\n  \r\n  async getUser(id) {\r\n    const response = await this.apiClient.get(`/users/${id}`);\r\n    return response.data;\r\n  }\r\n  \r\n  async createUser(userData) {\r\n    if (!utils.validateEmail(userData.email)) {\r\n      throw new Error('Invalid email');\r\n    }\r\n    const response = await this.apiClient.post('/users', userData);\r\n    return response.data;\r\n  }\r\n  \r\n  async updateUser(id, userData) {\r\n    const response = await this.apiClient.put(`/users/${id}`, userData);\r\n    return response.data;\r\n  }\r\n  \r\n  async deleteUser(id) {\r\n    const response = await this.apiClient.delete(`/users/${id}`);\r\n    return response.data;\r\n  }\r\n}\r\n\r\n// ============================================\r\n// EXAMPLE 1: Mocking Entire Modules\r\n// ============================================\r\n\r\ntest('mock entire API module', async () => {\r\n  // Create mock for entire API\r\n  const mockApi = {\r\n    get: jest.fn().mockResolvedValue({ data: { id: 1, name: 'Mocked User' } }),\r\n    post: jest.fn().mockResolvedValue({ data: { id: 2, success: true } }),\r\n    put: jest.fn().mockResolvedValue({ data: { success: true } }),\r\n    delete: jest.fn().mockResolvedValue({ data: { success: true } })\r\n  };\r\n  \r\n  const service = new UserService(mockApi);\r\n  \r\n  // Test getUser\r\n  const user = await service.getUser(1);\r\n  expect(user).toEqual({ id: 1, name: 'Mocked User' });\r\n  expect(mockApi.get).toHaveBeenCalledWith('/users/1');\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 2: Mocking External Libraries (axios pattern)\r\n// ============================================\r\n\r\ntest('mocking axios-like HTTP client', async () => {\r\n  // Mock axios-style client\r\n  const mockAxios = {\r\n    get: jest.fn(),\r\n    post: jest.fn(),\r\n    put: jest.fn(),\r\n    delete: jest.fn()\r\n  };\r\n  \r\n  // Setup mock responses\r\n  mockAxios.get.mockResolvedValue({\r\n    data: {\r\n      users: [\r\n        { id: 1, name: 'John' },\r\n        { id: 2, name: 'Jane' }\r\n      ]\r\n    }\r\n  });\r\n  \r\n  mockAxios.post.mockResolvedValue({\r\n    data: { id: 3, name: 'New User', success: true }\r\n  });\r\n  \r\n  // Use mocked client\r\n  const getResponse = await mockAxios.get('/users');\r\n  const postResponse = await mockAxios.post('/users', { name: 'New User' });\r\n  \r\n  expect(getResponse.data.users).toHaveLength(2);\r\n  expect(postResponse.data.id).toBe(3);\r\n  expect(mockAxios.get).toHaveBeenCalledWith('/users');\r\n  expect(mockAxios.post).toHaveBeenCalledWith('/users', { name: 'New User' });\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 3: Partial Mocks Pattern\r\n// ============================================\r\n\r\ntest('partial mock - keep some functions real', () => {\r\n  // Mock only specific functions from utils\r\n  const mockUtils = {\r\n    ...utils, // Keep real implementations\r\n    generateId: jest.fn().mockReturnValue('mocked-id-123') // Mock only this\r\n  };\r\n  \r\n  // Real functions still work\r\n  expect(mockUtils.validateEmail('test@example.com')).toBe(true);\r\n  expect(mockUtils.validateEmail('invalid')).toBe(false);\r\n  \r\n  // Mocked function returns our value\r\n  expect(mockUtils.generateId()).toBe('mocked-id-123');\r\n  expect(mockUtils.generateId).toHaveBeenCalled();\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 4: Manual Mock Pattern\r\n// ============================================\r\n\r\ntest('manual mock pattern with factory', () => {\r\n  // Factory function to create consistent mocks\r\n  function createMockApi() {\r\n    return {\r\n      get: jest.fn().mockResolvedValue({ data: {} }),\r\n      post: jest.fn().mockResolvedValue({ data: { success: true } }),\r\n      put: jest.fn().mockResolvedValue({ data: { success: true } }),\r\n      delete: jest.fn().mockResolvedValue({ data: { success: true } })\r\n    };\r\n  }\r\n  \r\n  const mockApi = createMockApi();\r\n  const service = new UserService(mockApi);\r\n  \r\n  // Customize mock for this test\r\n  mockApi.get.mockResolvedValue({\r\n    data: { id: 1, name: 'John', email: 'john@example.com' }\r\n  });\r\n  \r\n  // Test uses customized mock\r\n  service.getUser(1).then(user => {\r\n    expect(user.name).toBe('John');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 5: Mocking Node.js Built-in Modules Pattern\r\n// ============================================\r\n\r\ntest('simulating fs module mock', () => {\r\n  // Simulate mocking fs module\r\n  const mockFs = {\r\n    readFileSync: jest.fn(),\r\n    writeFileSync: jest.fn(),\r\n    existsSync: jest.fn(),\r\n    mkdirSync: jest.fn()\r\n  };\r\n  \r\n  // Setup mock behaviors\r\n  mockFs.existsSync.mockReturnValue(true);\r\n  mockFs.readFileSync.mockReturnValue('file content');\r\n  \r\n  // Use mock\r\n  const exists = mockFs.existsSync('/path/to/file');\r\n  const content = mockFs.readFileSync('/path/to/file', 'utf8');\r\n  \r\n  expect(exists).toBe(true);\r\n  expect(content).toBe('file content');\r\n  expect(mockFs.readFileSync).toHaveBeenCalledWith('/path/to/file', 'utf8');\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 6: Testing with Mocked Dependencies\r\n// ============================================\r\n\r\ndescribe('UserService with mocked API', () => {\r\n  let mockApi;\r\n  let userService;\r\n  \r\n  beforeEach(() => {\r\n    // Fresh mock for each test\r\n    mockApi = {\r\n      get: jest.fn(),\r\n      post: jest.fn(),\r\n      put: jest.fn(),\r\n      delete: jest.fn()\r\n    };\r\n    userService = new UserService(mockApi);\r\n  });\r\n  \r\n  test('getUser calls API with correct endpoint', async () => {\r\n    mockApi.get.mockResolvedValue({\r\n      data: { id: 1, name: 'John', email: 'john@example.com' }\r\n    });\r\n    \r\n    const user = await userService.getUser(1);\r\n    \r\n    expect(mockApi.get).toHaveBeenCalledWith('/users/1');\r\n    expect(user).toEqual({ id: 1, name: 'John', email: 'john@example.com' });\r\n  });\r\n  \r\n  test('createUser validates email before calling API', async () => {\r\n    mockApi.post.mockResolvedValue({\r\n      data: { id: 2, name: 'Jane', email: 'jane@example.com' }\r\n    });\r\n    \r\n    const userData = { name: 'Jane', email: 'jane@example.com' };\r\n    const user = await userService.createUser(userData);\r\n    \r\n    expect(mockApi.post).toHaveBeenCalledWith('/users', userData);\r\n    expect(user.id).toBe(2);\r\n  });\r\n  \r\n  test('createUser throws error for invalid email', async () => {\r\n    const userData = { name: 'Jane', email: 'invalid-email' };\r\n    \r\n    await expect(userService.createUser(userData)).rejects.toThrow('Invalid email');\r\n    expect(mockApi.post).not.toHaveBeenCalled();\r\n  });\r\n  \r\n  test('updateUser calls PUT endpoint', async () => {\r\n    mockApi.put.mockResolvedValue({ data: { success: true } });\r\n    \r\n    await userService.updateUser(1, { name: 'Updated Name' });\r\n    \r\n    expect(mockApi.put).toHaveBeenCalledWith('/users/1', { name: 'Updated Name' });\r\n  });\r\n  \r\n  test('deleteUser calls DELETE endpoint', async () => {\r\n    mockApi.delete.mockResolvedValue({ data: { success: true } });\r\n    \r\n    await userService.deleteUser(1);\r\n    \r\n    expect(mockApi.delete).toHaveBeenCalledWith('/users/1');\r\n  });\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 7: Verifying Mock Interactions\r\n// ============================================\r\n\r\ntest('verify all API interactions', async () => {\r\n  const mockApi = {\r\n    get: jest.fn().mockResolvedValue({ data: { id: 1, name: 'John' } }),\r\n    post: jest.fn().mockResolvedValue({ data: { id: 2, success: true } })\r\n  };\r\n  \r\n  const service = new UserService(mockApi);\r\n  \r\n  // Perform operations\r\n  await service.getUser(1);\r\n  await service.createUser({ name: 'New User', email: 'new@example.com' });\r\n  \r\n  // Verify all interactions\r\n  expect(mockApi.get).toHaveBeenCalledTimes(1);\r\n  expect(mockApi.get).toHaveBeenCalledWith('/users/1');\r\n  \r\n  expect(mockApi.post).toHaveBeenCalledTimes(1);\r\n  expect(mockApi.post).toHaveBeenCalledWith('/users', {\r\n    name: 'New User',\r\n    email: 'new@example.com'\r\n  });\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 8: Mock Implementation Patterns\r\n// ============================================\r\n\r\n// Pattern 1: Factory function\r\nfunction createApiMock() {\r\n  return {\r\n    get: jest.fn().mockResolvedValue({ data: {} }),\r\n    post: jest.fn().mockResolvedValue({ data: { success: true } }),\r\n    put: jest.fn().mockResolvedValue({ data: { success: true } }),\r\n    delete: jest.fn().mockResolvedValue({ data: { success: true } })\r\n  };\r\n}\r\n\r\ntest('using factory pattern', async () => {\r\n  const mockApi = createApiMock();\r\n  const service = new UserService(mockApi);\r\n  \r\n  mockApi.get.mockResolvedValue({ data: { id: 1, name: 'Test User' } });\r\n  \r\n  const user = await service.getUser(1);\r\n  expect(user.name).toBe('Test User');\r\n});\r\n\r\n// Pattern 2: Builder pattern for complex mocks\r\nclass MockApiBuilder {\r\n  constructor() {\r\n    this.mock = {\r\n      get: jest.fn(),\r\n      post: jest.fn(),\r\n      put: jest.fn(),\r\n      delete: jest.fn()\r\n    };\r\n  }\r\n  \r\n  withGetUser(userData) {\r\n    this.mock.get.mockResolvedValue({ data: userData });\r\n    return this;\r\n  }\r\n  \r\n  withPostSuccess() {\r\n    this.mock.post.mockResolvedValue({ data: { success: true } });\r\n    return this;\r\n  }\r\n  \r\n  withGetError(error) {\r\n    this.mock.get.mockRejectedValue(error);\r\n    return this;\r\n  }\r\n  \r\n  build() {\r\n    return this.mock;\r\n  }\r\n}\r\n\r\ntest('using builder pattern', async () => {\r\n  const mockApi = new MockApiBuilder()\r\n    .withGetUser({ id: 1, name: 'Built User' })\r\n    .withPostSuccess()\r\n    .build();\r\n  \r\n  const service = new UserService(mockApi);\r\n  \r\n  const user = await service.getUser(1);\r\n  expect(user.name).toBe('Built User');\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 9: Complex Mock Scenarios\r\n// ============================================\r\n\r\ntest('mock with varying responses', async () => {\r\n  const mockApi = {\r\n    get: jest.fn()\r\n      .mockResolvedValueOnce({ data: { id: 1, name: 'First Call' } })\r\n      .mockResolvedValueOnce({ data: { id: 2, name: 'Second Call' } })\r\n      .mockResolvedValue({ data: { id: 3, name: 'Default' } }),\r\n    post: jest.fn(),\r\n    put: jest.fn(),\r\n    delete: jest.fn()\r\n  };\r\n  \r\n  const service = new UserService(mockApi);\r\n  \r\n  const user1 = await service.getUser(1);\r\n  const user2 = await service.getUser(2);\r\n  const user3 = await service.getUser(3);\r\n  \r\n  expect(user1.name).toBe('First Call');\r\n  expect(user2.name).toBe('Second Call');\r\n  expect(user3.name).toBe('Default');\r\n});\r\n\r\ntest('mock with conditional responses', async () => {\r\n  const mockApi = {\r\n    get: jest.fn().mockImplementation((url) => {\r\n      if (url === '/users/1') {\r\n        return Promise.resolve({ data: { id: 1, name: 'John' } });\r\n      }\r\n      if (url === '/users/2') {\r\n        return Promise.resolve({ data: { id: 2, name: 'Jane' } });\r\n      }\r\n      return Promise.reject(new Error('User not found'));\r\n    }),\r\n    post: jest.fn(),\r\n    put: jest.fn(),\r\n    delete: jest.fn()\r\n  };\r\n  \r\n  const service = new UserService(mockApi);\r\n  \r\n  const user1 = await service.getUser(1);\r\n  const user2 = await service.getUser(2);\r\n  \r\n  expect(user1.name).toBe('John');\r\n  expect(user2.name).toBe('Jane');\r\n  \r\n  await expect(service.getUser(999)).rejects.toThrow('User not found');\r\n});\r\n\r\n// ============================================\r\n// EXAMPLE 10: Real-World Mock Patterns\r\n// ============================================\r\n\r\n// Database mock pattern\r\nclass MockDatabase {\r\n  constructor() {\r\n    this.data = new Map();\r\n    this.connect = jest.fn().mockResolvedValue(true);\r\n    this.disconnect = jest.fn().mockResolvedValue(true);\r\n    this.insert = jest.fn().mockImplementation((collection, doc) => {\r\n      const id = this.data.size + 1;\r\n      this.data.set(id, doc);\r\n      return Promise.resolve({ id, ...doc });\r\n    });\r\n    this.find = jest.fn().mockImplementation((collection, id) => {\r\n      return Promise.resolve(this.data.get(id) || null);\r\n    });\r\n  }\r\n}\r\n\r\ntest('using database mock', async () => {\r\n  const db = new MockDatabase();\r\n  \r\n  await db.connect();\r\n  expect(db.connect).toHaveBeenCalled();\r\n  \r\n  const doc = await db.insert('users', { name: 'John' });\r\n  expect(doc).toEqual({ id: 1, name: 'John' });\r\n  \r\n  const found = await db.find('users', 1);\r\n  expect(found).toEqual({ name: 'John' });\r\n  \r\n  await db.disconnect();\r\n  expect(db.disconnect).toHaveBeenCalled();\r\n});\n",
  "description": "## **Step 7: Mocking Modules**\r\n\r\n#### **Topic 1: jest.mock() - Mocking Entire Modules**\r\n**Explanation:**\r\n`jest.mock()` replaces an entire module with a mock. All functions in the module become mock functions.\r\n\r\n**Syntax:**\r\n```javascript\r\njest.mock('module-name');\r\n\r\n// Now all functions from 'module-name' are mocks\r\nimport { functionName } from 'module-name';\r\nfunctionName.mockReturnValue('mocked value');\r\n```\r\n\r\n**Use cases:**\r\n- Mock API clients (axios, fetch)\r\n- Mock database connections\r\n- Mock file system operations\r\n- Mock third-party libraries\r\n\r\n**Important:** `jest.mock()` is hoisted - it runs before imports!\r\n\r\n---\r\n\r\n#### **Topic 2: Mocking External Libraries (axios, etc.)**\r\n**Explanation:**\r\nCommon pattern for mocking HTTP clients:\r\n\r\n```javascript\r\nimport axios from 'axios';\r\njest.mock('axios');\r\n\r\ntest('fetches data', async () => {\r\n  axios.get.mockResolvedValue({ data: { name: 'John' } });\r\n  \r\n  const data = await fetchUser(1);\r\n  \r\n  expect(axios.get).toHaveBeenCalledWith('/users/1');\r\n  expect(data.name).toBe('John');\r\n});\r\n```\r\n\r\n---\r\n\r\n#### **Topic 3: Partial Mocks with jest.requireActual()**\r\n**Explanation:**\r\nSometimes you want to mock only part of a module and keep the rest real.\r\n\r\n**jest.requireActual()`** - Gets the real module implementation\r\n```javascript\r\njest.mock('module-name', () => ({\r\n  ...jest.requireActual('module-name'), // Keep real functions\r\n  specificFunction: jest.fn() // Mock only this one\r\n}));\r\n```\r\n\r\n**Example:**\r\n```javascript\r\njest.mock('./utils', () => ({\r\n  ...jest.requireActual('./utils'),\r\n  fetchData: jest.fn() // Mock only fetchData\r\n}));\r\n```\r\n\r\n---\r\n\r\n#### **Topic 4: Manual Mocks (__mocks__ Directory)**\r\n**Explanation:**\r\nCreate a `__mocks__` directory next to the module to provide a manual mock.\r\n\r\n**Directory structure:**\r\n```\r\nsrc/\r\n  api/\r\n    client.js\r\n    __mocks__/\r\n      client.js  <- Manual mock\r\n  users.js\r\n  users.test.js\r\n```\r\n\r\n**__mocks__/client.js:**\r\n```javascript\r\nexport const get = jest.fn();\r\nexport const post = jest.fn();\r\n```\r\n\r\n**In test:**\r\n```javascript\r\njest.mock('./api/client'); // Automatically uses manual mock\r\n```\r\n\r\n---\r\n\r\n#### **Topic 5: Mocking Node.js Built-in Modules (fs, path)**\r\n**Explanation:**\r\nFor Node.js built-ins, place mocks in `__mocks__` at project root:\r\n\r\n**__mocks__/fs.js:**\r\n```javascript\r\nmodule.exports = {\r\n  readFile: jest.fn(),\r\n  writeFile: jest.fn(),\r\n  readFileSync: jest.fn(),\r\n  writeFileSync: jest.fn()\r\n};\r\n```\r\n\r\n**In test:**\r\n```javascript\r\njest.mock('fs'); // Uses manual mock\r\nconst fs = require('fs');\r\n\r\ntest('reads file', () => {\r\n  fs.readFileSync.mockReturnValue('file content');\r\n  // Test code...\r\n});\r\n```\r\n\r\n---\r\n\r\n#### **Topic 6: jest.unmock() and jest.doMock()**\r\n**Explanation:**\r\n\r\n**jest.unmock()`** - Removes a mock\r\n```javascript\r\njest.mock('./module');\r\n// ... tests with mock\r\n\r\njest.unmock('./module');\r\n// ... tests with real module\r\n```\r\n\r\n**jest.doMock()`** - Runtime mocking (not hoisted)\r\n```javascript\r\ntest('test with mock', () => {\r\n  jest.doMock('./module', () => ({\r\n    getData: jest.fn().mockReturnValue('mocked')\r\n  }));\r\n  \r\n  const { getData } = require('./module');\r\n  expect(getData()).toBe('mocked');\r\n});\r\n```\r\n\r\n---\r\n\r\n#### **Topic 7: Auto-mocking Behavior**\r\n**Explanation:**\r\nJest can automatically mock modules, replacing all functions with `jest.fn()`.\r\n\r\n**Enable auto-mocking:**\r\n```javascript\r\n// jest.config.js\r\nmodule.exports = {\r\n  automock: true\r\n};\r\n```\r\n\r\n**Or per-test:**\r\n```javascript\r\njest.enableAutomock();\r\nimport module from './module'; // Automatically mocked\r\n\r\njest.disableAutomock();\r\nimport module from './module'; // Real implementation\r\n```\r\n\r\n**Note:** Auto-mocking is usually disabled by default. Manual mocking is more explicit and recommended.\r\n\r\n---\r\n\r\n#### **Topic 8: Testing with Mocked Dependencies**\r\n**Explanation:**\r\nPattern for testing code that depends on mocked modules:\r\n\r\n```javascript\r\n// userService.js\r\nimport api from './api';\r\n\r\nexport async function getUser(id) {\r\n  const response = await api.get(`/users/\\${id}`);\r\n  return response.data;\r\n}\r\n\r\n// userService.test.js\r\nimport api from './api';\r\nimport { getUser } from './userService';\r\n\r\njest.mock('./api');\r\n\r\ntest('getUser calls API correctly', async () => {\r\n  api.get.mockResolvedValue({\r\n    data: { id: 1, name: 'John' }\r\n  });\r\n  \r\n  const user = await getUser(1);\r\n  \r\n  expect(api.get).toHaveBeenCalledWith('/users/1');\r\n  expect(user).toEqual({ id: 1, name: 'John' });\r\n});\r\n```\r\n\r\n---\r\n\r\n#### **Topic 9: Verifying Mock Interactions**\r\n**Explanation:**\r\nCheck that mocked modules were used correctly:\r\n\r\n```javascript\r\ntest('verifies all interactions', async () => {\r\n  const mockApi = {\r\n    get: jest.fn().mockResolvedValue({ data: [] }),\r\n    post: jest.fn().mockResolvedValue({ data: { success: true } })\r\n  };\r\n  \r\n  // Use mockApi...\r\n  await mockApi.get('/users');\r\n  await mockApi.post('/users', { name: 'John' });\r\n  \r\n  // Verify\r\n  expect(mockApi.get).toHaveBeenCalledTimes(1);\r\n  expect(mockApi.post).toHaveBeenCalledTimes(1);\r\n  expect(mockApi.post).toHaveBeenCalledWith('/users', { name: 'John' });\r\n});\r\n```\r\n\r\n---\r\n\r\n#### **Topic 10: Mock Implementation Patterns**\r\n**Explanation:**\r\n\r\n**Pattern 1: Factory function for mocks**\r\n```javascript\r\nfunction createMockApiClient() {\r\n  return {\r\n    get: jest.fn(),\r\n    post: jest.fn(),\r\n    put: jest.fn(),\r\n    delete: jest.fn()\r\n  };\r\n}\r\n```\r\n\r\n**Pattern 2: Default implementations**\r\n```javascript\r\nconst mockApi = {\r\n  get: jest.fn().mockResolvedValue({ data: [] }),\r\n  post: jest.fn().mockResolvedValue({ data: { success: true } })\r\n};\r\n```\r\n\r\n**Pattern 3: Builder pattern for complex mocks**\r\n```javascript\r\nclass MockApiBuilder {\r\n  constructor() {\r\n    this.mock = { get: jest.fn(), post: jest.fn() };\r\n  }\r\n  \r\n  withGetSuccess(data) {\r\n    this.mock.get.mockResolvedValue({ data });\r\n    return this;\r\n  }\r\n  \r\n  withGetError(error) {\r\n    this.mock.get.mockRejectedValue(error);\r\n    return this;\r\n  }\r\n  \r\n  build() {\r\n    return this.mock;\r\n  }\r\n}\r\n```"
};
